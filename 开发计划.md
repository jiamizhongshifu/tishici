# 阶段 0：准备与稳定（0.5 周）

**目标**：梳理核心数据结构与接口，完成基础脚手架搭建。
**交付**：用户可在最小流程中生成 / 保存提示词。

## 0.1 数据层与 RLS

✅ 已完成：

- Supabase 已上线 `categories`、`prompts` 两张核心表，并启用 RLS。
  - `prompts`：仅允许 `user_id = auth.uid()` 访问自己的数据。
  - `categories`：所有用户可读，满足预设分类展示需求。
- 行为验证：通过 UI / Server Actions 完成 `prompts` CRUD，未出现越权读写。
- 新表 `prompt_metadata`、`eval_suites`、`eval_cases`、`prompt_runs` 已在 Supabase 中创建并启用 RLS，迁移脚本收录于 `supabase/migrations/202410160001_stage0_structures.sql`。

## 0.2 类型体系

✅ 已完成：

- 多语言词典 `lib/i18n.ts` 覆盖现有界面，可在中 / 英之间切换；复制按钮、提示 Toast 等交互支持动态文案。
- [TS-001] 使用 Zod 定义 `PromptCardMeta`、`EvalSuite` / `EvalCase`、`EvalRunOutput` 等核心类型，并在 Server Action / API 中落地校验。
- [CFG-001] 在 `lib/i18n.ts` 中补充 `linter.*`、`eval.*`、`bootstrap.*`、`versions.*` 词条。

## 0.3 最小基线

✅ 已完成：

- 迁移脚本 `supabase/migrations/0001_init.sql` 可直接执行并通过。
- 核心页面 `/`、`/dashboard`、`/prompts/new`、`/packs/[slug]` 均正常渲染，无报错。
  - `/prompts/new` 支持 “手动录入 / 定制生成” 两种模式，可保存提示词。
  - `/dashboard` 提供复制、删除操作，删除按钮含确认提示。
- `/api/generate`、`/api/prompts/[id]` API 运行正常，支持 OpenAI 兼容服务配置。

## 阶段 0 当前进度表

| 子任务 | 状态 | 说明 |
| --- | --- | --- |
| `categories` / `prompts` 表及 RLS | ✅ | 已上线并验证 |
| 新增表 + RLS（metadata / eval / runs） | ✅ | Supabase 已创建并写入迁移脚本 |
| 最小功能流程（首页 / 仪表盘 / 新建 / Packs） | ✅ | MVP 已可用 |
| 多语言基础（中 / 英切换 + Toast） | ✅ | 语言切换已生效 |
| Zod 类型体系 & i18n 扩展 | ✅ | 关键类型已由 Zod 校验并补齐命名域 |

> **阶段 0 结论**：MVP 已具备核心功能与多语言支持；数据表与 RLS 已完成部署，并进入版本管理。可继续推进阶段 1。

---

# 阶段 1：Linter + 结构元数据 + 小型评测（1.5 周）

**目标**：搭建“提示词结构 + 轻量评测”的基础框架。
**交付**：用户可查看 Linter 结果、补齐结构字段，并运行小型评测。

## 1.1 Linter 检查（覆写 & UI 提示）

✅ 已完成：
- LN-101 ~ LN-106 规则逻辑与评分模型（缺少目标 / 成功标准 / 时效提示 / 输入格式 / AI 自述 / 复杂度）。
- `/api/linter` 接口 + `PromptForm` 健康检查面板（自动运行、复制建议、忽略单条提示）。
- LN-107 增强项：在 `PromptForm` 中实现 Linter 提示定位与字段高亮，支持一键跳转处理问题。

## 1.2 结构化元数据

✅ 已完成：
- `PromptForm` 新增框架、成功标准、约束、输入格式、模型偏好、Token 预算、启动备注等字段。
- `createPrompt` Server Action 同步写入 `prompt_metadata`，支持多行解析。

## 1.3 轻量评测模块

✅ 已完成：
- [EV-101] API：`POST /api/eval/run`（支持 contains / regex / json_schema 断言，写入 `prompt_runs` 并返回统计）。
- [EV-102] `/dashboard` 评测入口 UI：新增 `EvalRunner`，可编辑套件 JSON、执行评测、查看用例结果。
- [EV-103] 断言类型实现（同上）。
- 评测历史：Dashboard 展示最近一次 `prompt_runs` 结果摘要（通过数 / 失败数 / 执行时间）。
- 评测套件复用：支持在 `EvalRunner` 中保存、加载、删除自定义评测套件（落库 `eval_suites` / `eval_cases`）。

## 阶段 1 验收标准（保持）

- 结构化字段填写覆盖率 ≥ 60%
- 评测断言命中率 ≥ 70%
- Linter 自动修复建议使用率 ≥ 40%
- 评测报告格式通过率 ≥ 90%

---

# 阶段 2：Prompt Packs（模板包）+ 版本对比（1 周）

**目标**：优质模板“一键复制”，提示可被稳步迭代。  
**里程碑**：两组精选 Pack 上架；版本 Diff 可视化。

## 2.1 Packs（仅模板卡，非流程）

- [PK-201] 新增包 **DanKoe Amplifier（5 卡）**：Idea Test / Source Distill / Structure Mine / Draft Mixer / Publish Cutter（均为**独立提示**）
- [PK-202] 新增包 **WX 基础要素（3 卡）**：信息检索 / 选题讨论 / 三遍审校（含来源时间戳与黑词清单）
- [PK-203] `/packs/[slug]`：卡片列表展示「一键复制到我的库」+「打开 ChatGPT」

## 2.2 版本管理（轻量）

- [VR-201] 新建版本 API：`POST /api/prompts/:id/version`（SemVer，默认 +1 PATCH）
- [VR-202] Diff 视图：比较**结构字段**与主体提示文本差异（两个区块内高亮）

## 阶段 2 当前进度

✅ 已完成：
- 建立 `prompt_versions` 表（含 RLS 与唯一约束）并迁移入库。
- `/api/prompts/[id]/version` 支持版本快照创建：自动计算补丁号，或校验自定义版本；保存正文与结构化元数据快照。
- 新增 DanKoe Amplifier / WX 基础要素两个 Packs，支持「导入到我的提示库」与「打开 ChatGPT」双操作。
- `/prompts/[id]` 详情页上线：可创建版本、切换对比、查看结构化字段与正文差异。

⏳ 待完成：无（阶段 2 进入验收总结）

## 阶段 2 验收标准

- Packs 复制→保存转化 ≥ 35%
- 版本 Diff 使用率 ≥ 20%
- 复制的模板卡 48h 内被运行（试跑 / 评测）≥ 40%

---

# 阶段 3：“提示词自举”功能集（2 周）

**目标**：在**单卡内**完成“自我改写 / 自我评审 / 自生成断言”，保持轻量、无需编排。  
**里程碑**：卡片详情出现“自举”页签，三大能力可用。

## 3.1 自举·API 与 UI

- [BS-301] API：`POST /api/prompts/:id/bootstrap/rewrite`（生成 **压缩版** 与 **稳健版**）
- [BS-302] API：`POST /api/prompts/:id/bootstrap/critique`（输出问题清单 / 修复建议 / 风险点）
- [BS-303] API：`POST /api/prompts/:id/bootstrap/make-evals`（生成 3–6 条最小断言）
- [BS-304] UI：卡片详情页新增 **Bootstrap** 页签（Rewrite / Critique / Evals 三个子页）
- [BS-305] 支持“**一键回填**或**另存为新版本**”
- [BS-306] 在 Linter 面板，加「**用自举修复**」快捷入口

### 阶段 3 准备情况

✅ 已完成：
- 新建 `prompt_bootstrap_runs` 表并设置 RLS / 索引（迁移 `202410170003_stage3_bootstrap_runs.sql`）。
- 定义自举输入/输出 Zod 模型（`lib/types/bootstrap.ts`），统一运行时校验。
- 提供 `npm run usage:collect` 统计脚本，聚合 `prompt_runs` 与 `prompt_bootstrap_runs` tokens / 成本，用于配额追踪。

⏳ 待完成：
- 封装模型调用工具（OpenAI / 代理）及统一的 token 计量写入逻辑。
- Bootstrap UI 原型与体验串联（CreateVersionForm 之后的 Rewrite/Critique 面板）。
- 离线/在线报警阈值设计（token、失败次数、成本等）。

## 3.2 自举·模板卡（Pack：Prompt Bootstrapper）

- [PK-204] A1 自举改写·压缩版（Compressed）
- [PK-205] A2 自举改写·稳健版（Robust）
- [PK-206] B1 自举评审（Critic）
- [PK-207] B2 变量发现（Variable Discovery）
- [PK-208] C1 断言生成（Make Evals）
- [PK-209] C2 去模型偏置（Model-Agnosticizer）
- [PK-210] D1 去 AI 腔（De-Jargonizer）
- [PK-211] D2 预算收敛（Token Budgeter）

## 阶段 3 验收标准

- 自举改写被采用（回填或新版本）≥ 35%
- 生成断言后首次试跑通过率 **+20pp**
- `token_budget` 填写的卡，平均输入 token 下降 ≥ 25%

---

# 阶段 4：轻量多模型试跑 + 收藏集 / 分享 + i18n 补齐（1.5 周）

**目标**：帮助用户对比两三个模型的稳定性；增加组织 / 分享，不做重协作。  
**里程碑**：同卡多模型试跑就绪；收藏 / 分享上线。

## 4.1 多模型试跑（轻量）

- [MM-401] API：`POST /api/prompts/:id/try-multi`（最多 3 模型，串行或小并发）
- [MM-402] UI：显示**结构合规率 / 字数 / 耗时**（仅关键差异）
- [MM-403] 与自举改写候选联动：一键对比压缩版 vs 稳健版在不同模型上的表现

## 4.2 收藏与分享

- [CL-401] `collections`（用户私有收藏集；简单排序 / 搜索）
- [CL-402] 只读分享链接（可关闭；不包含私密字段与运行记录）

## 4.3 i18n 补齐

- [I18N-401] 为上述新增页面与组件补齐字典；`LanguageToggle` 测试多语言切换

## 阶段 4 验收标准

- 多模型试跑使用率 ≥ 25%
- 收藏集覆盖率（≥1 集合）≥ 40%
- 分享→复制转化 ≥ 20%

---

# 阶段 5：打磨与观测（1 周）

**目标**：性能、成本、可用性细节完善；埋点与指标看板。  
**里程碑**：关键指标可视化，常见错误提示到位。

## 5.1 体验与性能

- [UX-501] 试跑 / 评测增加 Abort 超时、错误透传（含 baseURL / 模型未配置提示）
- [UX-502] 运行完成 Toast → “查看评测详情 / 再次试跑” 快速入口

## 5.2 指标与埋点

- [AN-501] `prompt_runs.stats` 记录 `input_tokens / output_tokens / latency_ms / model`
- [AN-502] `/dashboard` 顶部显示近 7 / 30 天趋势（简图或数字卡片）
- [AN-503] 关键目标追踪：
  - 结构化卡占比、Linter 采纳率、自举采纳率、跨模型试跑占比、平均 token 变化

## 5.3 文档与引导

- [DOC-501] 在 `/packs` 顶部放“写好提示词的 6 个要点”（KERNEL / DEPTH 要领的**一句话版本**）

## 阶段 5 验收标准

- P90 评测响应时间控制在可接受上限（如 ≤ 6s）
- 指标面板可读；核心指标每周可导出（CSV / JSON）

---

## 下一步开发计划（建议）

1. **评测数据深化**
   - 补齐 `prompt_runs.stats` 与真实模型调用数据的对接流程（温度 / token 计数 / 回合耗时等实时指标）。
   - 为评测套件保存功能补充命名规范、标签筛选及团队共享能力。
2. **阶段 2 启动准备**
   - 整理 DanKoe / WX 模板数据源，准备导入脚本与 UI 瓦片设计。
   - 版本管理 API 草稿（VR-201 / VR-202）。
3. **阶段 3 提前调研**
   - 明确自举 API 对接的模型能力与成本预估。
   - 设计 Bootstrap 页签交互原型，验证“回填 vs 新版本”使用场景。

---

## 未来 backlog（供 Issue 拆分参考）

- 数据层：DB-001 ~ DB-004
- 类型 / 配置：TS-001、CFG-001
- Linter：LN-101 ~ LN-107
- 评测：EV-101 ~ EV-103
- Packs：PK-201 ~ PK-211
- 版本管理：VR-201 ~ VR-202
- 自举：BS-301 ~ BS-306
- 多模型：MM-401 ~ MM-403
- 收藏 / 分享：CL-401 ~ CL-402
- i18n：I18N-401
- 观测 & UX：UX-501 ~ UX-502、AN-501 ~ AN-503、DOC-501

---

## 验收总目标（上线后 30 天）

- 含“成功标准 + 输出格式”的提示卡 ≥ **70%**
- Linter 修复采纳率 ≥ **40%**
- 自举改写被采用率 ≥ **35%**
- 平均输入 token **下降 ≥ 25%**
- 同卡跨模型试跑使用率 ≥ **25%**
- Packs 复制→保存转化 ≥ **35%**
