

# 🎯 总体目标（对齐你现状）

* 在不破坏现有 `prompts / prompt_versions / prompt_runs / prompt_bootstrap_runs / eval_*` 的前提下，新增**任务域**与**工作流配置域**，把“任务驱动 + 双层判断 + 工作区执行 + Prompt 链”闭环打通。
* 把“用量&成本”从评测统计中抽离成**全局维度**，为 Dashboard 提供指标底座。
* 依旧以“提示词管理”为核心：所有任务与阶段事件都应**回流到 Prompt 体系**（版本/评测/自举）。

---

# ⏱ 时间线（建议 8–10 周）

* **P0｜2–3 周**：Task Hub 闭环 + 数据/接口基础 + 顶层指标卡
* **P1｜3–4 周**：工作流配置化 + 任务详情&重放 + Prompt/General 工作区
* **P2｜3 周**：可视化编辑器 + 版本×套件矩阵 + 分享&成本护栏

> 每阶段末均进行“灰度开关 + 数据回溯校验 + 指标对齐”的回归。

---

# ✅ P0（Task Hub 闭环 · 最小可用）

## 1) 数据层（新增表 + RLS）

> 仅新增，不修改现有表，降低风险。

**schemas（示例）**

```sql
-- 1) 工作区定义（系统预置：article/prompt/general；video 后续）
create table public.workspaces (
  id uuid primary key default gen_random_uuid(),
  key text unique not null check (key in ('article','prompt','general','video')),
  name text not null,
  created_at timestamptz default now()
);

-- 2) 任务主表
create table public.tasks (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  workspace_key text not null references public.workspaces(key),
  title text,
  input_text text,               -- 用户自然语言需求/brief
  status text not null default 'active' check (status in ('active','completed','failed','archived')),
  current_stage text,            -- A/B/C/D/E 等阶段key
  prompt_id uuid,                -- 关联核心提示词（可为空，阶段中产生）
  metadata jsonb default '{}'::jsonb,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- 3) 任务事件明细（阶段推进流水账）
create table public.task_events (
  id uuid primary key default gen_random_uuid(),
  task_id uuid not null references public.tasks(id) on delete cascade,
  event_key text not null,       -- create / advance:A / rewrite / eval / apply ...
  stage_key text,                -- A/B/C/D/E
  input jsonb,                   -- 入参摘要（脱敏）
  output jsonb,                  -- 出参摘要（指向 run_id / version_id 等）
  prev_event_id uuid,
  created_at timestamptz default now()
);

-- 4) 工作流配置（JSON 驱动执行链）
create table public.workflow_configs (
  id uuid primary key default gen_random_uuid(),
  workspace_key text not null references public.workspaces(key),
  version text not null,         -- '1.0.0'
  name text not null,
  is_default boolean default false,
  config jsonb not null,         -- 存 WORKFLOW.json
  created_by uuid references auth.users(id),
  created_at timestamptz default now(),
  unique (workspace_key, version)
);

-- 5) 用量与成本（全局维度）
create table public.openai_usage (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  task_id uuid references public.tasks(id),
  run_id uuid,                   -- 可关联 prompt_runs.id / bootstrap_runs.id
  model text not null,
  input_tokens int default 0,
  output_tokens int default 0,
  cost_usd numeric(10,4) default 0,
  meta jsonb,
  created_at timestamptz default now()
);
```

**RLS（示例）**

```sql
alter table public.tasks enable row level security;
create policy tasks_owner_rw on public.tasks
  for all using (auth.uid()=user_id) with check (auth.uid()=user_id);

alter table public.task_events enable row level security;
create policy task_events_owner_r on public.task_events
  for select using (exists (select 1 from public.tasks t where t.id=task_id and t.user_id=auth.uid()));

alter table public.workflow_configs enable row level security;
create policy wf_read_public on public.workflow_configs
  for select using (true); -- 公共只读
create policy wf_write_owner on public.workflow_configs
  for all using (auth.uid()=created_by) with check (auth.uid()=created_by);

alter table public.openai_usage enable row level security;
create policy usage_owner_rw on public.openai_usage
  for all using (auth.uid()=user_id) with check (auth.uid()=user_id);
```

**Seed（workspaces）**

```sql
insert into public.workspaces(key,name) values
('article','文章'),('prompt','Prompt'),('general','通用');
```

---

## 2) API / Actions（契约与骨架）

**POST `/api/tasks`**（创建任务+第一层路由）

```ts
// body
{ inputText: string, preferredWorkspace?: 'article'|'prompt'|'general' }

// resp
{ taskId: string, workspaceKey: string, nextStage: 'A'|'B'|'C'|'D'|'E' }
```

* 路由策略：规则优先（关键词/长度/是否有原文等），后续可替换轻量分类器。
* 侧写：落 `tasks`、追加 `task_events:create`。

**POST `/api/tasks/{id}/advance`**（第二层推进 + 串既有能力）

```ts
// body
{ stage: 'A'|'B'|'C'|'D'|'E', action: 'generate'|'rewrite'|'apply'|'eval'|'linter'|'finish', params?: any }
// resp
{ ok: true, runId?: string, versionId?: string, nextStage?: string }
```

* 内部根据 `workflow_configs` 的当前步骤，转呼：

  * `POST /api/prompts/{id}/apply`
  * `POST /prompts/{id}/bootstrap/rewrite`
  * `POST /api/eval/run`
  * `POST /api/linter`
* 将 `run_id/version_id/model/tokens/cost` 写入 `task_events` 与 `openai_usage`。

> 说明：`lib/openai.ts:17` 处包装器返回的 tokens/cost 统一在这里落表，形成全局视角。

---

## 3) WORKFLOW.json（文章工作区 · MVP 范式）

```json
{
  "workspace": "article",
  "version": "1.0.0",
  "stages": {
    "A": { "name": "新写(有Brief)",
      "steps": [
        {"action":"save_brief"},
        {"action":"topic_select", "via":"linter"},
        {"action":"generate", "via":"apply", "with":"draft_template"},
        {"action":"review", "via":"linter"},
        {"action":"optimize", "via":"bootstrap/rewrite"}
      ]
    },
    "B": { "name": "新写(无Brief)",
      "steps": [
        {"action":"brief_generate", "via":"apply", "with":"brief_generator"},
        {"action":"topic_select", "via":"linter"},
        {"action":"generate", "via":"apply", "with":"draft_template"},
        {"action":"review", "via":"linter"}
      ]
    },
    "D": { "name": "审校优化",
      "steps": [
        {"action":"review", "via":"linter"},
        {"action":"eval", "via":"eval/run"},
        {"action":"optimize", "via":"bootstrap/rewrite"}
      ]
    }
  },
  "defaults": { "start": "A" }
}
```

---

## 4) 前端改造（最小影响）

* **Home → Task Hub（app/page.tsx）**

  * 新增“我想要…”输入框（textarea + 快捷标签：文章/Prompt/通用）。
  * 提交 → 调 `POST /api/tasks` → 跳转 Dashboard 并聚焦该任务卡。
  * 保留 Pack 摘要区块。

* **Dashboard（app/dashboard/page.tsx）**

  * 顶部新增指标卡：`本周成本 (openai_usage)`、`任务完成率`、`平均阶段数`。
  * 新增「任务」页签：按 `tasks` 列表展示状态、下一步按钮（Advance）。
  * 在原“提示词列表”卡片中显示最近绑定任务（浅关联）。

* **PromptDetail（app/prompts/[id]/page.tsx）**

  * 右侧“任务侧栏”：展示关联的 `tasks`、最近 `task_events`、一键跳转任务。

> 首屏仍保持稳定；新增 UI 基本都为“页内区块”。

---

## 5) 观测&日志（P0 范围）

* 在 `lib/openai.ts` 包装器中统一生成 `usageContext = { userId, taskId?, runId?, model, tokens, cost }` 回传至调用侧写 `openai_usage`。
* 在 `POST /api/tasks/{id}/advance` 中集中写 `task_events`，并将关键对象（prompt_id/version_id/run_id）落 `output` 字段，便于追溯。

---

## 6) 测试与验收（DoD）

* **数据**：新表迁移在本地 + 测试库通过；RLS 策略验证（非 owner 无法读写）。
* **流程**：从 Task Hub 创建 A/B 任务，能完整跑通到初稿+审校；`task_events/openai_usage` 有记录。
* **指标**：Dashboard 顶卡有值；与 `prompt_runs` 聚合比对一致性（±5% 容差）。
* **回滚**：灰度开关 `NEXT_PUBLIC_TASKS_ENABLED=false` 可一键关闭任务入口。

---

# ✅ P1（工作流配置化 · 可维护性）

## 1) 工作流版本化 & 校验

* `workflow_configs` 增加字段：`status ('draft'|'published')`、`notes text`。
* 引入 JSON Schema 校验（本地静态 + 运行时），保证 `steps[].via` 与现有 API 对齐。
* 支持从 Pack 导入工作流：Pack 详情页增加“导入工作流”按钮（与“导入模板提示词”并列）。

## 2) 任务详情页（时间线 & 重放）

* 新页 `app/tasks/[id]/page.tsx`：按时间顺序展示 `task_events`，提供：

  * **重放（Replay）**：对含 `run_id/version_id` 的事件提供“一键重放上一步”。
  * **对齐**：展示 tokens/cost、模型、通过率（若有 eval）。

## 3) Prompt / General 工作区

* **Prompt 工作区**：实验 → 对比 → 版本保存（复用现有 `prompt_versions` 与 `eval_suites`）。
* **General 工作区**：Think-Aloud 快问快答（轻量落 `task_events`，不必生成 `prompt_id`）。

## 4) 评测联动

* 在阶段配置中允许指定 `eval_suite_id`；`advance` 时自动触发 `POST /api/eval/run`，形成“阶段→评测→通过率”闭环。

**P1 DoD**

* `WORKFLOW.json` 可以版本化/发布；任务详情支持时间线&重放；Prompt/General 工作区可用；评测联动阶段可选。

---

# ✅ P2（可视化与协作 · 价值放大）

## 1) 可视化工作流编辑器（轻量）

* 节点（阶段）与连线（条件）拖拽，保存为 `workflow_configs.config`。
* 只做 MVP：新增/删除节点、设置 `steps[].via/action/with`。

## 2) 矩阵视图（版本×套件）

* 页面：`/dashboard/matrix`
* 数据：`prompt_versions × eval_suites` 生成热力图（通过率、平均 tokens、成本/千字）。

## 3) 分享与导入

* 任务/工作流/评测套件生成只读分享链接（签名短链），“复制到我的空间”落到当前用户。
* **成本护栏**：在 `openai_usage` 上设置 per-user 预算阈值，超过后：

  * Header 红点提醒 + Toast
  * `advance` 自动 fallback 小模型（配置中指定）。

**P2 DoD**

* 可视化编辑器可 round-trip；矩阵视图出结果；分享链接有效；预算策略能触发降级。

---

# 📊 Dashboard 指标与查询（样例）

**本周成本**

```sql
select coalesce(sum(cost_usd),0) as cost
from openai_usage
where user_id=auth.uid() and created_at >= date_trunc('week', now());
```

**任务完成率**

```sql
select
  count(*) filter (where status='completed')::float / greatest(count(*),1) as completion_rate
from tasks where user_id=auth.uid()
  and created_at >= date_trunc('week', now());
```

**平均阶段数**

```sql
select avg(cnt) from (
  select task_id, count(*) as cnt
  from task_events te
  join tasks t on t.id=te.task_id
  where t.user_id=auth.uid()
    and te.created_at >= date_trunc('week', now())
  group by task_id
) s;
```

---

# 🔌 前后端改造点位（具体到文件）

* **DB 迁移**：`supabase/migrations/20251018_stage4_tasks_workflows.sql`
* **OpenAI 包装器**：`lib/openai.ts` 增加 usage 回传与 `openai_usage` 落表函数
* **API**

  * `app/api/tasks/route.ts`（POST）
  * `app/api/tasks/[id]/advance/route.ts`（POST）
  * `app/api/workflows/[workspace]/route.ts`（GET）
* **Server Actions**（如需）

  * `app/actions.ts` 补 `createTask`, `advanceTask`
* **前端**

  * `app/page.tsx`：Task Hub 输入框 + 快速分类
  * `app/dashboard/page.tsx`：顶卡 + 任务页签
  * `app/tasks/[id]/page.tsx`：时间线与重放
  * `components/TaskCard.tsx`、`components/MetricCard.tsx`
* **校验**

  * `lib/workflow/schema.ts`（Zod/JSON Schema）
  * `lib/types/task.ts`（类型定义）

---

# 🧪 测试矩阵（关键用例）

* 创建任务（带/不带 workspace 偏好）→ 正确路由 → 生成初稿
* 阶段推进失败回滚：上一步可重放；`task_events.prev_event_id` 生效
* 评测阶段触发与通过率计算正确；linter 定位到字段
* openai_usage 与 prompt_runs 的 tokens/cost 一致性
* RLS：跨用户数据不可见；workflow_configs 只读可见
* 预算阈值触发模型降级（P2）

---

# ⚠️ 风险与缓解

* **事件爆炸**：`task_events` 增长快 → 周期性归档（物化视图/冷存储）
* **JSON 配置漂移**：引入 Schema 校验 + config 版本化 + lint 告警
* **成本失控**：P0 先记录，P2 才启“护栏”；先做看板可视化
* **用户心智复杂**：P0 UI 只加“任务卡”和“顶卡”，避免打破现有使用习惯

---

# 📌 小结

这份计划在你现有 MVP 的基础上，以**最小增量**引入任务与工作流，把“你要解决什么任务？”作为入口，再把**Prompt 管理**稳稳放在核心。
建议从 **P0 的数据表与两个 API** 开始落地：它们一旦可用，你的 Dashboard 就能“长出”任务维度和成本维度，产品的可观察性、可运营性就到位了。
